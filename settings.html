<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Email Template Previewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .settings-section { background: white; padding: 1.5rem; border-radius: 1rem; margin-bottom: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .settings-section h2 { font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: #1e293b; }
        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; font-weight: 500; margin-bottom: 0.5rem; color: #475569; }
        .form-input { width: 100%; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; }
        .form-input:focus { outline: none; border-color: #3b82f6; ring: 2px; ring-color: #3b82f6; }
        .btn { padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background-color: #3b82f6; color: white; }
        .btn-primary:hover { background-color: #2563eb; }
        .btn-secondary { background-color: #64748b; color: white; }
        .btn-secondary:hover { background-color: #475569; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-danger:hover { background-color: #dc2626; }
        .btn-success { background-color: #10b981; color: white; }
        .btn-success:hover { background-color: #059669; }
        .spam-word-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: #f8fafc; border-radius: 0.5rem; margin-bottom: 0.5rem; }
        .spam-word-category { display: inline-block; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600; }
        .category-urgency { background: #fee2e2; color: #991b1b; }
        .category-shady { background: #fce7f3; color: #831843; }
        .category-money { background: #fef3c7; color: #92400e; }
        .category-overpromise { background: #fed7aa; color: #9a3412; }
        .category-unnatural { background: #e2e8f0; color: #334155; }
        .notification { position: fixed; top: 1rem; right: 1rem; padding: 1rem; background: #10b981; color: white; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 1000; }
    </style>
</head>
<body>
    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <div class="flex items-center justify-between mb-6">
            <h1 class="text-3xl font-bold text-slate-900">
                <i class="fas fa-cog mr-2"></i> Settings
            </h1>
            <div class="flex gap-2">
                <a href="index.html" class="btn btn-secondary">
                    <i class="fas fa-arrow-left mr-2"></i> Back to Editor
                </a>
                <a href="templates.html" class="btn btn-ghost">
                    <i class="fas fa-database mr-2"></i> Templates Library
                </a>
            </div>
        </div>
        <!-- Gemini API Configuration Section -->
        <div class="settings-section">
            <h2><i class="fas fa-robot mr-2"></i> Gemini API Configuration</h2>
            <div class="form-group">
                <label class="form-label">Gemini API Key</label>
                <div class="flex gap-2">
                    <input type="password" id="gemini-api-key" class="form-input flex-1" placeholder="Enter your Gemini API key">
                    <button id="toggle-api-key" class="btn btn-secondary" type="button">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <p class="text-sm text-slate-500 mt-1">
                    Get your free API key from 
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-600 hover:text-blue-700 underline">
                        Google AI Studio
                    </a>
                </p>
            </div>
            <div class="form-group">
                <label class="form-label">AI Model</label>
                <select id="ai-model" class="form-input" disabled>
                    <option value="gemini-2.5-flash-lite" selected>Gemini 2.5 Flash-Lite</option>
                </select>
                <p class="text-sm text-slate-500 mt-1">Using Gemini 2.5 Flash-Lite for optimal performance and cost efficiency</p>
            </div>
            <div class="form-group">
                <label class="form-label">Custom System Prompt</label>
                <textarea id="system-prompt" class="form-input" rows="4" placeholder="Enter custom system prompt for AI (optional)">You are an expert email marketing assistant. Help users create professional, engaging, and spam-filter-friendly emails.</textarea>
                <p class="text-sm text-slate-500 mt-1">Customize how the AI responds to your requests</p>
            </div>
            <button id="save-ai-config" class="btn btn-primary">
                <i class="fas fa-save mr-2"></i> Save Gemini Configuration
            </button>
        </div>

        <!-- Spam Words Management Section -->
        <div class="settings-section">
            <h2><i class="fas fa-shield-alt mr-2"></i> Spam Words Management</h2>
            <div class="form-group">
                <label class="form-label">Add New Spam Word</label>
                <div class="flex gap-2">
                    <input type="text" id="new-spam-word" class="form-input flex-1" placeholder="Enter spam word or phrase">
                    <select id="spam-word-category" class="form-input" style="max-width: 150px;">
                        <option value="urgency">Urgency</option>
                        <option value="shady">Shady</option>
                        <option value="money">Money</option>
                        <option value="overpromise">Overpromise</option>
                        <option value="unnatural">Unnatural</option>
                    </select>
                    <button id="add-spam-word-btn" class="btn btn-success">
                        <i class="fas fa-plus"></i> Add
                    </button>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Custom Spam Words</label>
                <div id="custom-spam-words-list" class="max-h-96 overflow-y-auto">
                    <!-- Custom spam words will be listed here -->
                </div>
            </div>
            <div class="flex gap-2">
                <button id="export-spam-words" class="btn btn-secondary">
                    <i class="fas fa-download mr-2"></i> Export Words
                </button>
                <button id="import-spam-words" class="btn btn-secondary">
                    <i class="fas fa-upload mr-2"></i> Import Words
                </button>
                <input type="file" id="import-file" accept=".json" style="display: none;">
            </div>
        </div>
        
        <!-- AI Prompt Templates Section -->
        <div class="settings-section">
            <h2><i class="fas fa-file-code mr-2"></i> AI Prompt Templates</h2>
            <p class="text-sm text-slate-500 mb-3">Use placeholders like {systemPrompt}, {content}, {tone}, {terms}, {subjectLine}. These will be replaced before sending to AI.</p>
            
            <!-- Bulk Prompt Management -->
            <div class="bg-gradient-to-r from-blue-50 to-purple-50 border border-blue-200 rounded-lg p-4 mb-6">
                <h3 class="text-lg font-semibold text-blue-900 mb-3 flex items-center">
                    <i class="fas fa-magic mr-2"></i> Bulk Prompt Management
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="form-label">Bulk Update All Prompts</label>
                        <textarea id="bulk-prompt-text" class="form-input font-mono text-sm" rows="8" placeholder="Paste your prompt text here...

SUPPORTED FORMATS:
1. Single text - applies same text to all prompts
2. Structured format with sections:
=== SYSTEM PROMPT ===
Your system prompt here...

=== OPTIMIZE PROMPT ===
Your optimize prompt here...

=== SUGGEST PROMPT ===
Your suggest prompt here...

=== TONE PROMPT ===
Your tone prompt here...

=== SUBJECT PROMPT ===
Your subject prompt here...

=== REWRITE PROMPT ===
Your rewrite prompt here..."></textarea>
                        <p class="text-xs text-slate-500 mt-1">Supports both single text (applies to all) and structured format (individual prompts)</p>
                        <button id="apply-bulk-prompts" class="btn btn-primary mt-2">
                            <i class="fas fa-sync mr-2"></i> Apply Prompts
                        </button>
                    </div>
                    <div>
                        <label class="form-label">Import/Export Prompts</label>
                        <div class="space-y-2">
                            <button id="export-all-prompts" class="btn btn-secondary w-full">
                                <i class="fas fa-download mr-2"></i> Export All Prompts
                            </button>
                            <button id="import-prompts" class="btn btn-secondary w-full">
                                <i class="fas fa-upload mr-2"></i> Import Prompts
                            </button>
                            <input type="file" id="import-prompts-file" accept=".json" style="display: none;">
                            <button id="copy-all-prompts" class="btn btn-secondary w-full">
                                <i class="fas fa-copy mr-2"></i> Copy All to Clipboard
                            </button>
                        </div>
                        <p class="text-xs text-slate-500 mt-2">Export/Import all prompts as JSON for backup or sharing</p>
                    </div>
                </div>
            </div>
            <details class="mb-4">
                <summary class="cursor-pointer text-slate-700 font-medium">More info about placeholders</summary>
                <div class="mt-2 text-sm text-slate-600 space-y-2 bg-slate-50 border border-slate-200 rounded-lg p-3">
                    <div>
                        <span class="font-semibold text-slate-800">{systemPrompt}</span> – The global system instruction saved in AI Configuration. Sets the assistant's role and style.
                    </div>
                    <div>
                        <span class="font-semibold text-slate-800">{content}</span> – The current email HTML from the left editor. Passed as-is, including tags.
                    </div>
                    <div>
                        <span class="font-semibold text-slate-800">{tone}</span> – The tone you enter when using “Adjust Tone” (e.g., professional, friendly).
                    </div>
                    <div>
                        <span class="font-semibold text-slate-800">{terms}</span> – For "Rewrite Spam Words", the comma-separated words/phrases you choose, provided to AI as JSON (e.g., ["free", "limited time"]).
                    </div>
                    <div>
                        <span class="font-semibold text-slate-800">{subjectLine}</span> – The current subject line from the preview section.
                    </div>
                    <div class="pt-2 border-t border-slate-200">
                        <span class="font-semibold text-slate-800">Tips</span>
                        <ul class="list-disc pl-5 mt-1 space-y-1">
                            <li>You can reorder or wrap placeholders with additional instructions.</li>
                            <li>Keep structure and any required output format (e.g., JSON) in your template.</li>
                            <li>If a placeholder is missing at runtime, it will be replaced with an empty string.</li>
                        </ul>
                    </div>
                </div>
            </details>
            <div class="form-group">
                <label class="form-label">Optimize Content Template</label>
                <textarea id="prompt-optimize" class="form-input font-mono text-sm" rows="5" placeholder="Enter optimize prompt template..."></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Suggestions Template</label>
                <textarea id="prompt-suggest" class="form-input font-mono text-sm" rows="7" placeholder="Enter suggestions prompt template..."></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Adjust Tone Template</label>
                <textarea id="prompt-tone" class="form-input font-mono text-sm" rows="5" placeholder="Enter tone prompt template..."></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Generate Subject Template</label>
                <textarea id="prompt-subject" class="form-input font-mono text-sm" rows="5" placeholder="Enter subject prompt template..."></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Rewrite Spam Words Template</label>
                <textarea id="prompt-rewrite" class="form-input font-mono text-sm" rows="10" placeholder="Enter rewrite spam words template..."></textarea>
            </div>
            <div class="flex gap-2">
                <button id="save-prompt-templates" class="btn btn-primary">
                    <i class="fas fa-save mr-2"></i> Save Prompt Templates
                </button>
                <button id="reset-prompt-templates" class="btn btn-secondary">
                    <i class="fas fa-undo mr-2"></i> Reset to Defaults
                </button>
            </div>
        </div>
        <!-- Email Signature Section -->
        <div class="settings-section">
            <h2><i class="fas fa-signature mr-2"></i> Email Signature</h2>
            <div class="form-group">
                <label class="form-label">Signature HTML</label>
                <textarea id="signature-html" class="form-input font-mono text-sm" rows="8" placeholder="Enter your email signature HTML..."></textarea>
                <p class="text-sm text-slate-500 mt-1">Enter HTML for your email signature. This can be inserted into your emails.</p>
            </div>
            <div class="form-group">
                <label class="form-label">Signature Preview</label>
                <div id="signature-preview" class="border border-slate-300 rounded-lg p-4 bg-white min-h-24">
                    <p class="text-slate-400 italic">No signature set</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button id="save-signature" class="btn btn-primary">
                    <i class="fas fa-save mr-2"></i> Save Signature
                </button>
                <button id="clear-signature" class="btn btn-danger">
                    <i class="fas fa-trash mr-2"></i> Clear Signature
                </button>
                <button id="insert-signature-to-editor" class="btn btn-secondary">
                    <i class="fas fa-plus-circle mr-2"></i> Insert in Editor
                </button>
            </div>
        </div>

        <!-- Reset Settings Section -->
        <div class="settings-section">
            <h2><i class="fas fa-undo mr-2"></i> Reset Settings</h2>
            <p class="text-slate-600 mb-4">Reset all settings to default values. This action cannot be undone.</p>
            <button id="reset-all-settings" class="btn btn-danger">
                <i class="fas fa-exclamation-triangle mr-2"></i> Reset All Settings
            </button>
        </div>
    </div>

    <div id="notification" class="notification" style="display: none;"></div>

    <script>
        // Settings Manager
        const SettingsManager = {
            init() {
                this.loadSettings();
                this.bindEvents();
            },

            loadSettings() {
                // Load Gemini API Configuration
                const geminiApiKey = localStorage.getItem('gemini-api-key') || '';
                const systemPrompt = localStorage.getItem('system-prompt') || 'You are an expert email marketing assistant. Help users create professional, engaging, and spam-filter-friendly emails.';
                document.getElementById('gemini-api-key').value = geminiApiKey;
                document.getElementById('system-prompt').value = systemPrompt;

                // Load custom spam words
                this.loadCustomSpamWords();

                // Load signature
                const signature = localStorage.getItem('email-signature') || '';
                document.getElementById('signature-html').value = signature;
                this.updateSignaturePreview();

                // Load AI prompt templates (with defaults)
                const defaults = this.getDefaultPromptTemplates();
                document.getElementById('prompt-optimize').value = localStorage.getItem('prompt-optimize') || defaults.optimize;
                document.getElementById('prompt-suggest').value = localStorage.getItem('prompt-suggest') || defaults.suggest;
                document.getElementById('prompt-tone').value = localStorage.getItem('prompt-tone') || defaults.tone;
                document.getElementById('prompt-subject').value = localStorage.getItem('prompt-subject') || defaults.subject;
                document.getElementById('prompt-rewrite').value = localStorage.getItem('prompt-rewrite') || defaults.rewrite;
            },
            bindEvents() {
                // AI Configuration
                document.getElementById('save-ai-config').addEventListener('click', () => this.saveAIConfig());
                document.getElementById('toggle-api-key').addEventListener('click', () => this.toggleApiKeyVisibility());
                // Prompt Templates
                document.getElementById('save-prompt-templates').addEventListener('click', () => this.savePromptTemplates());
                document.getElementById('reset-prompt-templates').addEventListener('click', () => this.resetPromptTemplates());
                
                // Bulk Prompt Management
                document.getElementById('apply-bulk-prompts').addEventListener('click', () => this.applyBulkPrompts());
                document.getElementById('export-all-prompts').addEventListener('click', () => this.exportAllPrompts());
                document.getElementById('import-prompts').addEventListener('click', () => document.getElementById('import-prompts-file').click());
                document.getElementById('import-prompts-file').addEventListener('change', (e) => this.importPrompts(e));
                document.getElementById('copy-all-prompts').addEventListener('click', () => this.copyAllPromptsToClipboard());

                // Spam Words Management
                document.getElementById('add-spam-word-btn').addEventListener('click', () => this.addCustomSpamWord());
                document.getElementById('export-spam-words').addEventListener('click', () => this.exportSpamWords());
                document.getElementById('import-spam-words').addEventListener('click', () => document.getElementById('import-file').click());
                document.getElementById('import-file').addEventListener('change', (e) => this.importSpamWords(e));

                // Signature Management
                document.getElementById('signature-html').addEventListener('input', () => this.updateSignaturePreview());
                document.getElementById('save-signature').addEventListener('click', () => this.saveSignature());
                document.getElementById('clear-signature').addEventListener('click', () => this.clearSignature());
                document.getElementById('insert-signature-to-editor').addEventListener('click', () => this.insertSignatureToEditor());

                // Reset Settings
                document.getElementById('reset-all-settings').addEventListener('click', () => this.resetAllSettings());
            },
            getDefaultPromptTemplates() {
                return {
                    optimize: `{systemPrompt}\n\nOptimize this email content for better engagement and deliverability. Make it more professional and compelling while maintaining the original intent.\n\nIMPORTANT: Keep your response concise (under 200 words). Focus on the most impactful improvements only.\n\nContent: {content}`,
                    suggest: `{systemPrompt}\n\nAnalyze this email content and provide specific suggestions for improvement. Focus on:\n1. Subject line recommendations\n2. Content structure improvements\n3. Call-to-action optimization\n4. Spam avoidance tips\n\nIMPORTANT: Keep your response concise (under 150 words). Provide only the most critical suggestions.\n\nContent: {content}`,
                    tone: `{systemPrompt}\n\nRewrite this email content to have a {tone} tone while maintaining the same message and structure.\n\nIMPORTANT: Keep your response concise. Return only the rewritten content without explanations.\n\nContent: {content}`,
                    subject: `{systemPrompt}\n\nGenerate 5 compelling subject lines for this email.\n\nCurrent Subject Template: {subjectLine}\nEmail Content: {content}\n\nIMPORTANT: Return only the 5 subject lines, one per line, without explanations or numbering. If the current subject uses variables like {{company_name}}, you can use similar variable patterns in your suggestions.`,
                    rewrite: `{systemPrompt}\n\nYou will receive a list of exact words/phrases and an email HTML.\nReturn ONLY a JSON array of objects with shape: [{"from":"...","to":"..."}].\n\nCRITICAL RULES:\n- NEVER return the same word as the replacement. Always provide a different, better alternative.\n- Propose safe, natural, non-spammy replacements that are clearly different from the original.\n- Replace ONLY the provided words/phrases when they appear as text; do NOT change structure, HTML tags, links, or variables like {{name}}.\n- Keep case and punctuation sensible; if a phrase is part of a larger word, do not replace.\n- If you cannot find a good replacement, omit that word from the response entirely.\n\nTERMS:\n{terms}\n\nEMAIL_HTML:\n{content}`
                };
            },
            savePromptTemplates() {
                const ids = ['prompt-optimize','prompt-suggest','prompt-tone','prompt-subject','prompt-rewrite'];
                ids.forEach(id => {
                    const val = document.getElementById(id).value;
                    if (val && val.trim()) localStorage.setItem(id, val);
                });
                this.showNotification('Prompt templates saved successfully!');
            },
            resetPromptTemplates() {
                if (!confirm('Reset all AI prompt templates to the original defaults?')) return;
                const defaults = this.getDefaultPromptTemplates();
                document.getElementById('prompt-optimize').value = defaults.optimize;
                document.getElementById('prompt-suggest').value = defaults.suggest;
                document.getElementById('prompt-tone').value = defaults.tone;
                document.getElementById('prompt-subject').value = defaults.subject;
                document.getElementById('prompt-rewrite').value = defaults.rewrite;
                // Persist defaults immediately
                localStorage.setItem('prompt-optimize', defaults.optimize);
                localStorage.setItem('prompt-suggest', defaults.suggest);
                localStorage.setItem('prompt-tone', defaults.tone);
                localStorage.setItem('prompt-subject', defaults.subject);
                localStorage.setItem('prompt-rewrite', defaults.rewrite);
                this.showNotification('Prompt templates reset to defaults!');
            },

            // Bulk Prompt Management Functions
            applyBulkPrompts() {
                const bulkText = document.getElementById('bulk-prompt-text').value.trim();
                if (!bulkText) {
                    this.showNotification('Please enter prompt text to apply to all templates', 'error');
                    return;
                }

                // Check if it's structured format (contains section headers)
                if (bulkText.includes('=== SYSTEM PROMPT ===') || bulkText.includes('=== OPTIMIZE PROMPT ===')) {
                    this.parseAndApplyStructuredPrompts(bulkText);
                } else {
                    // Apply same text to all prompts
                    if (!confirm('This will replace ALL prompt templates with the same text. Are you sure?')) {
                        return;
                    }

                    const promptIds = ['prompt-optimize', 'prompt-suggest', 'prompt-tone', 'prompt-subject', 'prompt-rewrite'];
                    promptIds.forEach(id => {
                        document.getElementById(id).value = bulkText;
                        localStorage.setItem(id, bulkText);
                    });

                    document.getElementById('bulk-prompt-text').value = '';
                    this.showNotification('All prompt templates updated successfully!');
                }
            },

            parseAndApplyStructuredPrompts(text) {
                try {
                    const prompts = this.extractPromptsFromStructuredText(text);
                    let updatedCount = 0;

                    // Update system prompt if found
                    if (prompts.systemPrompt) {
                        document.getElementById('system-prompt').value = prompts.systemPrompt;
                        localStorage.setItem('system-prompt', prompts.systemPrompt);
                        updatedCount++;
                    }

                    // Update individual prompt templates
                    const promptMappings = {
                        'optimize': 'prompt-optimize',
                        'suggest': 'prompt-suggest', 
                        'tone': 'prompt-tone',
                        'subject': 'prompt-subject',
                        'rewrite': 'prompt-rewrite'
                    };

                    Object.keys(promptMappings).forEach(key => {
                        if (prompts[key]) {
                            const elementId = promptMappings[key];
                            document.getElementById(elementId).value = prompts[key];
                            localStorage.setItem(elementId, prompts[key]);
                            updatedCount++;
                        }
                    });

                    if (updatedCount > 0) {
                        document.getElementById('bulk-prompt-text').value = '';
                        this.showNotification(`Successfully updated ${updatedCount} prompt template(s)!`);
                    } else {
                        this.showNotification('No valid prompts found in the structured format', 'error');
                    }
                } catch (error) {
                    this.showNotification('Error parsing structured prompts. Please check the format.', 'error');
                }
            },

            extractPromptsFromStructuredText(text) {
                const prompts = {};
                
                // Define section patterns
                const sections = [
                    { key: 'systemPrompt', pattern: /=== SYSTEM PROMPT ===\s*\n(.*?)(?=\n===|$)/s },
                    { key: 'optimize', pattern: /=== OPTIMIZE PROMPT ===\s*\n(.*?)(?=\n===|$)/s },
                    { key: 'suggest', pattern: /=== SUGGEST PROMPT ===\s*\n(.*?)(?=\n===|$)/s },
                    { key: 'tone', pattern: /=== TONE PROMPT ===\s*\n(.*?)(?=\n===|$)/s },
                    { key: 'subject', pattern: /=== SUBJECT PROMPT ===\s*\n(.*?)(?=\n===|$)/s },
                    { key: 'rewrite', pattern: /=== REWRITE PROMPT ===\s*\n(.*?)(?=\n===|$)/s }
                ];

                sections.forEach(section => {
                    const match = text.match(section.pattern);
                    if (match && match[1]) {
                        prompts[section.key] = match[1].trim();
                    }
                });

                return prompts;
            },

            exportAllPrompts() {
                const prompts = {
                    optimize: localStorage.getItem('prompt-optimize') || this.getDefaultPromptTemplates().optimize,
                    suggest: localStorage.getItem('prompt-suggest') || this.getDefaultPromptTemplates().suggest,
                    tone: localStorage.getItem('prompt-tone') || this.getDefaultPromptTemplates().tone,
                    subject: localStorage.getItem('prompt-subject') || this.getDefaultPromptTemplates().subject,
                    rewrite: localStorage.getItem('prompt-rewrite') || this.getDefaultPromptTemplates().rewrite,
                    systemPrompt: localStorage.getItem('system-prompt') || '',
                    exportDate: new Date().toISOString(),
                    version: '1.0'
                };

                const dataStr = JSON.stringify(prompts, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `prompt-templates-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
                this.showNotification('All prompts exported successfully!');
            },

            importPrompts(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        if (!confirm('This will replace all current prompt templates. Are you sure?')) {
                            event.target.value = '';
                            return;
                        }

                        // Import individual prompts
                        if (importedData.optimize) {
                            document.getElementById('prompt-optimize').value = importedData.optimize;
                            localStorage.setItem('prompt-optimize', importedData.optimize);
                        }
                        if (importedData.suggest) {
                            document.getElementById('prompt-suggest').value = importedData.suggest;
                            localStorage.setItem('prompt-suggest', importedData.suggest);
                        }
                        if (importedData.tone) {
                            document.getElementById('prompt-tone').value = importedData.tone;
                            localStorage.setItem('prompt-tone', importedData.tone);
                        }
                        if (importedData.subject) {
                            document.getElementById('prompt-subject').value = importedData.subject;
                            localStorage.setItem('prompt-subject', importedData.subject);
                        }
                        if (importedData.rewrite) {
                            document.getElementById('prompt-rewrite').value = importedData.rewrite;
                            localStorage.setItem('prompt-rewrite', importedData.rewrite);
                        }
                        if (importedData.systemPrompt) {
                            document.getElementById('system-prompt').value = importedData.systemPrompt;
                            localStorage.setItem('system-prompt', importedData.systemPrompt);
                        }

                        this.showNotification('Prompts imported successfully!');
                    } catch (error) {
                        this.showNotification('Error importing prompts. Invalid file format.', 'error');
                    }
                };
                reader.readAsText(file);
                event.target.value = '';
            },

            copyAllPromptsToClipboard() {
                const prompts = {
                    optimize: localStorage.getItem('prompt-optimize') || this.getDefaultPromptTemplates().optimize,
                    suggest: localStorage.getItem('prompt-suggest') || this.getDefaultPromptTemplates().suggest,
                    tone: localStorage.getItem('prompt-tone') || this.getDefaultPromptTemplates().tone,
                    subject: localStorage.getItem('prompt-subject') || this.getDefaultPromptTemplates().subject,
                    rewrite: localStorage.getItem('prompt-rewrite') || this.getDefaultPromptTemplates().rewrite,
                    systemPrompt: localStorage.getItem('system-prompt') || ''
                };

                const textToCopy = `=== AI PROMPT TEMPLATES ===
Generated: ${new Date().toLocaleString()}

=== SYSTEM PROMPT ===
${prompts.systemPrompt}

=== OPTIMIZE PROMPT ===
${prompts.optimize}

=== SUGGEST PROMPT ===
${prompts.suggest}

=== TONE PROMPT ===
${prompts.tone}

=== SUBJECT PROMPT ===
${prompts.subject}

=== REWRITE PROMPT ===
${prompts.rewrite}`;

                navigator.clipboard.writeText(textToCopy).then(() => {
                    this.showNotification('All prompts copied to clipboard!');
                }).catch(() => {
                    this.showNotification('Failed to copy to clipboard', 'error');
                });
            },

            saveAIConfig() {
                const apiKey = document.getElementById('gemini-api-key').value.trim();
                const prompt = document.getElementById('system-prompt').value;
                
                if (!apiKey) {
                    this.showNotification('Please enter your Gemini API key', 'error');
                    return;
                }
                
                localStorage.setItem('gemini-api-key', apiKey);
                localStorage.setItem('system-prompt', prompt);
                this.showNotification('Gemini configuration saved successfully!');
            },

            toggleApiKeyVisibility() {
                const apiKeyInput = document.getElementById('gemini-api-key');
                const toggleBtn = document.getElementById('toggle-api-key');
                const icon = toggleBtn.querySelector('i');
                
                if (apiKeyInput.type === 'password') {
                    apiKeyInput.type = 'text';
                    icon.className = 'fas fa-eye-slash';
                } else {
                    apiKeyInput.type = 'password';
                    icon.className = 'fas fa-eye';
                }
            },

            loadCustomSpamWords() {
                const customWords = JSON.parse(localStorage.getItem('custom-spam-words') || '[]');
                const container = document.getElementById('custom-spam-words-list');
                
                if (customWords.length === 0) {
                    container.innerHTML = '<p class="text-slate-400 italic">No custom spam words added yet</p>';
                    return;
                }

                container.innerHTML = customWords.map((word, index) => `
                    <div class="spam-word-item">
                        <div>
                            <span class="font-medium">${word.keyword}</span>
                            <span class="spam-word-category category-${word.category} ml-2">${word.category}</span>
                        </div>
                        <button class="text-red-600 hover:text-red-700" onclick="SettingsManager.removeCustomSpamWord(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `).join('');
            },

            addCustomSpamWord() {
                const word = document.getElementById('new-spam-word').value.trim();
                const category = document.getElementById('spam-word-category').value;

                if (!word) {
                    this.showNotification('Please enter a spam word', 'error');
                    return;
                }

                const customWords = JSON.parse(localStorage.getItem('custom-spam-words') || '[]');
                customWords.push({
                    keyword: word,
                    category: category,
                    highlight: new RegExp('\\\\b' + word.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&') + '\\\\b', 'gi').source
                });

                localStorage.setItem('custom-spam-words', JSON.stringify(customWords));
                document.getElementById('new-spam-word').value = '';
                this.loadCustomSpamWords();
                this.showNotification('Spam word added successfully!');
            },
            removeCustomSpamWord(index) {
                const customWords = JSON.parse(localStorage.getItem('custom-spam-words') || '[]');
                customWords.splice(index, 1);
                localStorage.setItem('custom-spam-words', JSON.stringify(customWords));
                this.loadCustomSpamWords();
                this.showNotification('Spam word removed successfully!');
            },

            exportSpamWords() {
                const customWords = JSON.parse(localStorage.getItem('custom-spam-words') || '[]');
                const dataStr = JSON.stringify(customWords, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'custom-spam-words.json';
                link.click();
                URL.revokeObjectURL(url);
                this.showNotification('Spam words exported successfully!');
            },

            importSpamWords(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedWords = JSON.parse(e.target.result);
                        if (!Array.isArray(importedWords)) {
                            throw new Error('Invalid format');
                        }
                        localStorage.setItem('custom-spam-words', JSON.stringify(importedWords));
                        this.loadCustomSpamWords();
                        this.showNotification('Spam words imported successfully!');
                    } catch (error) {
                        this.showNotification('Error importing spam words. Invalid file format.', 'error');
                    }
                };
                reader.readAsText(file);
                event.target.value = '';
            },

            updateSignaturePreview() {
                const html = document.getElementById('signature-html').value;
                const preview = document.getElementById('signature-preview');
                if (html.trim()) {
                    preview.innerHTML = html;
                } else {
                    preview.innerHTML = '<p class="text-slate-400 italic">No signature set</p>';
                }
            },

            saveSignature() {
                const signature = document.getElementById('signature-html').value;
                localStorage.setItem('email-signature', signature);
                this.showNotification('Signature saved successfully!');
            },

            clearSignature() {
                if (confirm('Are you sure you want to clear your signature?')) {
                    document.getElementById('signature-html').value = '';
                    localStorage.removeItem('email-signature');
                    this.updateSignaturePreview();
                    this.showNotification('Signature cleared successfully!');
                }
            },

            insertSignatureToEditor() {
                const signature = localStorage.getItem('email-signature');
                if (!signature) {
                    this.showNotification('No signature saved. Please save a signature first.', 'error');
                    return;
                }
                localStorage.setItem('insert-signature-flag', 'true');
                window.location.href = 'index.html';
            },
            resetAllSettings() {
                if (confirm('Are you sure you want to reset ALL settings? This cannot be undone.')) {
                    localStorage.removeItem('gemini-api-key');
                    localStorage.removeItem('system-prompt');
                    localStorage.removeItem('custom-spam-words');
                    localStorage.removeItem('email-signature');
                    this.loadSettings();
                    this.showNotification('All settings have been reset to defaults!');
                }
            },

            showNotification(message, type = 'success') {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.style.display = 'block';
                notification.style.backgroundColor = type === 'error' ? '#ef4444' : '#10b981';
                
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 3000);
            }
        };

        // Initialize settings manager
        SettingsManager.init();
    </script>
</body>
</html>
